<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>RetryTransaction (Java Class Library API)</title>
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body>
<script type="text/javascript"><!--
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="RetryTransaction (Java Class Library API)";
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar_top">
<!--   -->
</a><a href="#skip-navbar_top" title="Skip navigation links"></a><a name="navbar_top_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/RetryTransaction.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../org/dellroad/stuff/spring/ResourceReaderFactoryBean.html" title="class in org.dellroad.stuff.spring"><span class="strong">Prev Class</span></a></li>
<li><a href="../../../../org/dellroad/stuff/spring/RetryTransactionProvider.html" title="interface in org.dellroad.stuff.spring"><span class="strong">Next Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?org/dellroad/stuff/spring/RetryTransaction.html" target="_top">Frames</a></li>
<li><a href="RetryTransaction.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Required&nbsp;|&nbsp;</li>
<li><a href="#annotation_type_optional_element_summary">Optional</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#annotation_type_element_detail">Element</a></li>
</ul>
</div>
<a name="skip-navbar_top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">org.dellroad.stuff.spring</div>
<h2 title="Annotation Type RetryTransaction" class="title">Annotation Type RetryTransaction</h2>
</div>
<div class="contentContainer">
<div class="description">
<ul class="blockList">
<li class="blockList">
<hr>
<br>
<pre><a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Documented.html?is-external=true" title="class or interface in java.lang.annotation">@Documented</a>
<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Inherited.html?is-external=true" title="class or interface in java.lang.annotation">@Inherited</a>
<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Retention.html?is-external=true" title="class or interface in java.lang.annotation">@Retention</a>(<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Retention.html?is-external=true#value()" title="class or interface in java.lang.annotation">value</a>=<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/RetentionPolicy.html?is-external=true#RUNTIME" title="class or interface in java.lang.annotation">RUNTIME</a>)
<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Target.html?is-external=true" title="class or interface in java.lang.annotation">@Target</a>(<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Target.html?is-external=true#value()" title="class or interface in java.lang.annotation">value</a>={<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/ElementType.html?is-external=true#TYPE" title="class or interface in java.lang.annotation">TYPE</a>,<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/annotation/ElementType.html?is-external=true#METHOD" title="class or interface in java.lang.annotation">METHOD</a>})
public @interface <a href="../../../../src-html/org/dellroad/stuff/spring/RetryTransaction.html#line.110">RetryTransaction</a></pre>
<div class="block">An annotation for <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/annotation/Transactional.html?is-external=true" title="class or interface in org.springframework.transaction.annotation"><code>@Transactional</code></a> methods that
 want to have transactions automatically retried when they fail due to a transient exception. A transient exception
 is one that Spring would translate into a
 <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/dao/TransientDataAccessException.html?is-external=true" title="class or interface in org.springframework.dao"><code>TransientDataAccessException</code></a>.

 <p>
 This automatic retry logic is very handy for solving the problem of transient deadlocks that can occur in complex Java/ORM
 applications. Due to the ORM layer hiding the details of the underlying data access patterns, it's often difficult
 to design Java/ORM applications such that transient deadlocks at the database layer can't occur. Since these
 deadlocks can often be dealt with simply by retrying the transaction, having retry logic automatically applied can
 eliminate this problem.

 <p>
 Note, beans involved in transactions should either be stateless, or be prepared to rollback any state changes on transaction
 failure; of course, this is true whether or not transactions are automatically being retried, but adding automatic retry
 can magnify pre-existing bugs of that nature.

 <p>
 The <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html" title="annotation in org.dellroad.stuff.spring"><code>@RetryTransaction</code></a> annotation is ignored unless all of the following conditions are satisfied:
 <ul>
  <li>
      The method (and/or the containing type) must be annotated with both
      <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/annotation/Transactional.html?is-external=true" title="class or interface in org.springframework.transaction.annotation"><code>@Transactional</code></a>
      and <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html" title="annotation in org.dellroad.stuff.spring"><code>@RetryTransaction</code></a>
  </li>
  <li>
      The <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/annotation/Transactional.html?is-external=true" title="class or interface in org.springframework.transaction.annotation"><code>@Transactional</code></a> annotation must have
      <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/annotation/Transactional.html?is-external=true#propagation" title="class or interface in org.springframework.transaction.annotation">propagation</a> set to either
      <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/TransactionDefinition.html?is-external=true#PROPAGATION_REQUIRED" title="class or interface in org.springframework.transaction"><code>PROPAGATION_REQUIRED</code></a> or
      <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/TransactionDefinition.html?is-external=true#PROPAGATION_REQUIRES_NEW" title="class or interface in org.springframework.transaction"><code>PROPAGATION_REQUIRES_NEW</code></a>
      (other propagation values do not involve creating new transactions).
  </li>
  <li>
      In the case of
      <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/TransactionDefinition.html?is-external=true#PROPAGATION_REQUIRED" title="class or interface in org.springframework.transaction"><code>PROPAGATION_REQUIRED</code></a> propagation,
      there must not be a transaction already open in the calling thread. In other words, the invoked method must
      be the one responsible for creating the transaction.
  </li>
  <li>
      The method's class must be woven (either at build time or runtime) using the
      <a href="http://www.eclipse.org/aspectj/doc/released/faq.php#compiler">AspectJ compiler</a>
      with the <code>RetryTransactionAspect</code> aspect (included in the <code>dellroad-stuff</code> JAR file).
  </li>
  <li>
      The <code>RetryTransactionAspect</code> aspect must be configured with a
      <a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/dao/support/PersistenceExceptionTranslator.html?is-external=true" title="class or interface in org.springframework.dao.support"><code>PersistenceExceptionTranslator</code></a> appropriate for
      the ORM layer being used. The simplest way to do this is to include the aspect in your Spring application context,
      for example:
      <pre>

      &lt;bean class="org.dellroad.stuff.spring.RetryTransactionAspect" factory-method="aspectOf"
        p:persistenceExceptionTranslator-ref="myJpaDialect"/&gt;
      </pre>This also gives you the opportunity to change the default values for <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#maxRetries()"><code>maxRetries()</code></a>, <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#initialDelay()"><code>initialDelay()</code></a>,
      and <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#maximumDelay()"><code>maximumDelay()</code></a>, which are applied when not explicitly overridden in the annotation, for example:
      <pre>

      &lt;bean class="org.dellroad.stuff.spring.RetryTransactionAspect" factory-method="aspectOf"
        p:persistenceExceptionTranslator-ref="myJpaDialect" p:maxRetriesDefault="2"
        p:initialDelayDefault="25" p:maximumDelayDefault="5000"/&gt;
      </pre>
  </li>
 </ul>

 <p>
 Logging behavior: Normal activity is logged at trace level, retries are logged at debug level, and errors are logged
 at error level.

 <p>
 Transactional code can determine the transaction attempt number using the <a href="../../../../org/dellroad/stuff/spring/RetryTransactionProvider.html" title="interface in org.dellroad.stuff.spring"><code>RetryTransactionProvider</code></a> interface
 implemented by the aspect. <a href="../../../../org/dellroad/stuff/spring/RetryTransactionProvider.html#getAttemptNumber()"><code>RetryTransactionProvider.getAttemptNumber()</code></a> method returns the current attempt number
 (1, 2, 3...), or zero if the current thread is not executing within activated retry logic:
  <blockquote><pre>
      import org.dellroad.stuff.spring.RetryTransactionProvider;
      ...

      &#64;Autowired
      private RetryTransactionProvider retryTransactionProvider;
      ...

      &#64;RetryTransaction
      &#64;Transactional
      public void doSomething() {
          ...
          final int attempt = this.retryTransactionProvider.getAttempt();
          ...
      }
   </pre></blockquote></div>
<dl><dt><span class="strong">See Also:</span></dt><dd><a href="http://docs.spring.io/spring/docs/4.1.x/javadoc-api/org/springframework/transaction/annotation/Transactional.html?is-external=true" title="class or interface in org.springframework.transaction.annotation"><code>Transactional</code></a></dd></dl>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- =========== ANNOTATION TYPE OPTIONAL MEMBER SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="annotation_type_optional_element_summary">
<!--   -->
</a>
<h3>Optional Element Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Optional Element Summary table, listing optional elements, and an explanation">
<caption><span>Optional Elements</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Optional Element and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>long</code></td>
<td class="colLast"><code><strong><a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#initialDelay()">initialDelay</a></strong></code>
<div class="block">The initial delay between retry attempts in milliseconds.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>long</code></td>
<td class="colLast"><code><strong><a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#maximumDelay()">maximumDelay</a></strong></code>
<div class="block">The maximum delay between retry attempts in milliseconds.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><code>int</code></td>
<td class="colLast"><code><strong><a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#maxRetries()">maxRetries</a></strong></code>
<div class="block">The maximum number of transaction retry attempts.</div>
</td>
</tr>
</table>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ============ ANNOTATION TYPE MEMBER DETAIL =========== -->
<ul class="blockList">
<li class="blockList"><a name="annotation_type_element_detail">
<!--   -->
</a>
<h3>Element Detail</h3>
<a name="maxRetries()">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>maxRetries</h4>
<pre>public abstract&nbsp;int&nbsp;<a href="../../../../src-html/org/dellroad/stuff/spring/RetryTransaction.html#line.147">maxRetries</a></pre>
<div class="block">The maximum number of transaction retry attempts.

 <p>
 If the transaction fails, it will be retried at most this many times.
 This limit applies to retries only; it does not apply to the very first attempt, which is always made.
 So a value of zero means at most one attempt.

 <p>
 If this property is not set explicitly, the default value of <code>-1</code> indicates that the aspect-wide default value
 (<a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#DEFAULT_MAX_RETRIES">4</a> by default), should be used.</div>
<dl><dt><span class="strong">Returns:</span></dt><dd>maximum number of transaction retry attempts</dd></dl>
<dl>
<dt>Default:</dt>
<dd>-1</dd>
</dl>
</li>
</ul>
<a name="initialDelay()">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>initialDelay</h4>
<pre>public abstract&nbsp;long&nbsp;<a href="../../../../src-html/org/dellroad/stuff/spring/RetryTransaction.html#line.160">initialDelay</a></pre>
<div class="block">The initial delay between retry attempts in milliseconds.
 After the first transaction failure, we will pause for approximately this many milliseconds.
 For additional failures we apply a randomized exponential back-off, up to a maximum of <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#maximumDelay()"><code>maximumDelay()</code></a>.

 <p>
 If this property is not set explicitly, the default value of <code>-1</code> indicates that the aspect-wide default value
 (<a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#DEFAULT_INITIAL_DELAY">100L</a> milliseconds by default), should be used.</div>
<dl><dt><span class="strong">Returns:</span></dt><dd>initial delay between retry attempts in milliseconds</dd></dl>
<dl>
<dt>Default:</dt>
<dd>-1L</dd>
</dl>
</li>
</ul>
<a name="maximumDelay()">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>maximumDelay</h4>
<pre>public abstract&nbsp;long&nbsp;<a href="../../../../src-html/org/dellroad/stuff/spring/RetryTransaction.html#line.173">maximumDelay</a></pre>
<div class="block">The maximum delay between retry attempts in milliseconds.
 After the first transaction failure, we will pause for approximately <a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#initialDelay()"><code>initialDelay()</code></a> milliseconds.
 For additional failures we apply a randomized exponential back-off, up to a maximum of this value.

 <p>
 If this property is not set explicitly, the default value of <code>-1</code> indicates that the aspect-wide default value
 (<a href="../../../../org/dellroad/stuff/spring/RetryTransaction.html#DEFAULT_MAXIMUM_DELAY">30000L</a> milliseconds by default), should be used.</div>
<dl><dt><span class="strong">Returns:</span></dt><dd>maximum delay between retry attempts in milliseconds</dd></dl>
<dl>
<dt>Default:</dt>
<dd>-1L</dd>
</dl>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar_bottom">
<!--   -->
</a><a href="#skip-navbar_bottom" title="Skip navigation links"></a><a name="navbar_bottom_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/RetryTransaction.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../org/dellroad/stuff/spring/ResourceReaderFactoryBean.html" title="class in org.dellroad.stuff.spring"><span class="strong">Prev Class</span></a></li>
<li><a href="../../../../org/dellroad/stuff/spring/RetryTransactionProvider.html" title="interface in org.dellroad.stuff.spring"><span class="strong">Next Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?org/dellroad/stuff/spring/RetryTransaction.html" target="_top">Frames</a></li>
<li><a href="RetryTransaction.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Required&nbsp;|&nbsp;</li>
<li><a href="#annotation_type_optional_element_summary">Optional</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#annotation_type_element_detail">Element</a></li>
</ul>
</div>
<a name="skip-navbar_bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
