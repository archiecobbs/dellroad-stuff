<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>RetryTransaction (DellRoad Stuff 3.0.4 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: org.dellroad.stuff.spring, annotation type: RetryTransaction">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
<script type="text/javascript" src="../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var pathtoroot = "../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/RetryTransaction.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li><a href="#field-summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#annotation-interface-optional-element-summary">Optional</a>&nbsp;|&nbsp;</li>
<li>Required</li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li><a href="#field-detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#annotation-interface-element-detail">Element</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.dellroad.stuff.spring</a></div>
<h1 title="Annotation Interface RetryTransaction" class="title">Annotation Interface RetryTransaction</h1>
</div>
<section class="class-description" id="class-description">
<hr>
<div class="type-signature"><span class="annotations"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Documented.html" title="class or interface in java.lang.annotation" class="external-link">@Documented</a>
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Inherited.html" title="class or interface in java.lang.annotation" class="external-link">@Inherited</a>
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Retention.html" title="class or interface in java.lang.annotation" class="external-link">@Retention</a>(<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/RetentionPolicy.html#RUNTIME" title="class or interface in java.lang.annotation" class="external-link">RUNTIME</a>)
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/Target.html" title="class or interface in java.lang.annotation" class="external-link">@Target</a>({<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/ElementType.html#TYPE" title="class or interface in java.lang.annotation" class="external-link">TYPE</a>,<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/annotation/ElementType.html#METHOD" title="class or interface in java.lang.annotation" class="external-link">METHOD</a>})
</span><span class="modifiers">public @interface </span><span class="element-name type-name-label">RetryTransaction</span></div>
<div class="block">An annotation for <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/annotation/Transactional.html" title="class or interface in org.springframework.transaction.annotation" class="external-link"><code>@Transactional</code></a> methods that
 want to have transactions automatically retried when they fail due to a transient exception. A transient exception
 is one that Spring would translate into a
 <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/dao/TransientDataAccessException.html" title="class or interface in org.springframework.dao" class="external-link"><code>TransientDataAccessException</code></a>.

 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/prism.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-java.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-xml-doc.min.js"></script>
 <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/themes/prism.min.css" rel="stylesheet"/>

 <p>
 This automatic retry logic is very handy for solving the problem of transient deadlocks that can occur in complex Java/ORM
 applications. Due to the ORM layer hiding the details of the underlying data access patterns, it's often difficult
 to design Java/ORM applications such that transient deadlocks at the database layer can't occur. Since these
 deadlocks can often be dealt with simply by retrying the transaction, having retry logic automatically applied can
 eliminate this problem.

 <p>
 Note, beans involved in transactions should either be stateless, or be prepared to rollback any state changes on transaction
 failure; of course, this is true whether or not transactions are automatically being retried, but adding automatic retry
 can magnify pre-existing bugs of that nature.

 <p>
 The <a href="RetryTransaction.html" title="annotation interface in org.dellroad.stuff.spring"><code>@RetryTransaction</code></a> annotation is ignored unless all of the following conditions are satisfied:
 <ul>
  <li>
      The method (and/or the containing type) must be annotated with both
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/annotation/Transactional.html" title="class or interface in org.springframework.transaction.annotation" class="external-link"><code>@Transactional</code></a>
      and <a href="RetryTransaction.html" title="annotation interface in org.dellroad.stuff.spring"><code>@RetryTransaction</code></a>
  </li>
  <li>
      The <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/annotation/Transactional.html" title="class or interface in org.springframework.transaction.annotation" class="external-link"><code>@Transactional</code></a> annotation must have
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/annotation/Transactional.html#propagation()" title="class or interface in org.springframework.transaction.annotation" class="external-link">propagation</a> set to either
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/TransactionDefinition.html#PROPAGATION_REQUIRED" title="class or interface in org.springframework.transaction" class="external-link"><code>PROPAGATION_REQUIRED</code></a> or
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/TransactionDefinition.html#PROPAGATION_REQUIRES_NEW" title="class or interface in org.springframework.transaction" class="external-link"><code>PROPAGATION_REQUIRES_NEW</code></a>
      (other propagation values do not involve creating new transactions).
  </li>
  <li>
      In the case of
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/TransactionDefinition.html#PROPAGATION_REQUIRED" title="class or interface in org.springframework.transaction" class="external-link"><code>PROPAGATION_REQUIRED</code></a> propagation,
      there must not be a transaction already open in the calling thread (under the same transaction manager). In other words,
      the invoked method must be the one responsible for creating a new transaction.
  </li>
  <li>
      The method's class must be woven (either at build time or runtime) using the
      <a href="http://www.eclipse.org/aspectj/doc/released/faq.php#compiler">AspectJ compiler</a>
      with the <code>RetryTransactionAspect</code> aspect (included in the <code>dellroad-stuff</code> JAR file).
  </li>
  <li>
      The <code>RetryTransactionAspect</code> aspect must be configured with a
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/dao/support/PersistenceExceptionTranslator.html" title="class or interface in org.springframework.dao.support" class="external-link"><code>PersistenceExceptionTranslator</code></a> appropriate for
      the ORM layer being used.

      <p>
      This is required because the <code>RetryTransactionAspect</code> doesn't know <i>a priori</i> which exceptions are
      "retryable" and which exceptions are hard errors. However, this is something that the
      <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/dao/support/PersistenceExceptionTranslator.html" title="class or interface in org.springframework.dao.support" class="external-link"><code>PersistenceExceptionTranslator</code></a> knows,
      because part of its job is wrapping lower-layer exceptions in <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/dao/package-summary.html" class="external-link"><code>org.springframework.dao</code></a> exceptions,
      in particular <a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/dao/TransientDataAccessException.html" title="class or interface in org.springframework.dao" class="external-link"><code>TransientDataAccessException</code></a>.

      <p>
      The simplest way to do this is to include the aspect in your Spring application context, for example:

      <pre><code class="language-xml">
      &lt;bean class="org.dellroad.stuff.spring.RetryTransactionAspect" factory-method="aspectOf"
        p:persistenceExceptionTranslator-ref="myJpaDialect"/&gt;
      </code></pre>

      <p>
      This also gives you the opportunity to change the default values for <a href="#maxRetries()"><code>maxRetries()</code></a>, <a href="#initialDelay()"><code>initialDelay()</code></a>,
      and <a href="#maximumDelay()"><code>maximumDelay()</code></a>, which are applied when not explicitly overridden in the annotation, for example:

      <pre><code class="language-xml">
      &lt;bean class="org.dellroad.stuff.spring.RetryTransactionAspect" factory-method="aspectOf"
        p:persistenceExceptionTranslator-ref="myJpaDialect" p:maxRetriesDefault="2"
        p:initialDelayDefault="25" p:maximumDelayDefault="5000"/&gt;
      </code></pre>
  </li>
 </ul>

 <p>
 Logging behavior: Normal activity is logged at trace level, retries are logged at debug level, and errors are logged
 at error level.

 <p>
 Transactional code can determine the transaction attempt number using the <a href="RetryTransactionProvider.html" title="interface in org.dellroad.stuff.spring"><code>RetryTransactionProvider</code></a> interface
 implemented by the aspect. <a href="RetryTransactionProvider.html#getAttemptNumber()"><code>RetryTransactionProvider.getAttemptNumber()</code></a> method returns the current attempt number
 (1, 2, 3...), or zero if the current thread is not executing within activated retry logic:
  <pre><code class="language-java">
      import org.dellroad.stuff.spring.RetryTransactionProvider;
      ...

      &#64;Autowired
      private RetryTransactionProvider retryTransactionProvider;
      ...

      &#64;RetryTransaction
      &#64;Transactional
      public void doSomething() {
          ...
          final int attempt = this.retryTransactionProvider.getAttemptNumber();
          ...
      }
 </code></pre>

 <p>
 You can acquire also the singleton <a href="RetryTransactionProvider.html" title="interface in org.dellroad.stuff.spring"><code>RetryTransactionProvider</code></a> instance directly like this:
  <pre><code class="language-java">
      import org.dellroad.stuff.spring.RetryTransactionAspect;
      import org.dellroad.stuff.spring.RetryTransactionProvider;
      ...

      &#64;RetryTransaction
      &#64;Transactional
      public void doSomething() {
          ...
          final RetryTransactionProvider rtp = RetryTransactionAspect.aspectOf();
          final int attempt = rtp.getAttemptNumber();
          ...
      }
 </code></pre>

 <p>
 You can also invoke the retry logic directly (i.e., without going through a method woven with the aspect); see
 <a href="RetryTransactionProvider.html#retry(org.dellroad.stuff.spring.RetryTransactionProvider.RetrySetup)"><code>RetryTransactionProvider.retry()</code></a>.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="RetryTransactionProvider.html" title="interface in org.dellroad.stuff.spring"><code>RetryTransactionProvider</code></a></li>
<li><a href="https://docs.spring.io/spring-framework/docs/6.1.4/javadoc-api/org/springframework/transaction/annotation/Transactional.html" title="class or interface in org.springframework.transaction.annotation" class="external-link"><code>Transactional</code></a></li>
</ul>
</dd>
</dl>
</section>
<section class="summary">
<ul class="summary-list">
<!-- =========== ANNOTATION INTERFACE OPTIONAL MEMBER SUMMARY =========== -->
<li>
<section class="member-summary" id="annotation-interface-optional-element-summary">
<h2>Optional Element Summary</h2>
<div class="caption"><span>Optional Elements</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Optional Element</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>long</code></div>
<div class="col-second even-row-color"><code><a href="#initialDelay()" class="member-name-link">initialDelay</a></code></div>
<div class="col-last even-row-color">
<div class="block">The initial delay between retry attempts in milliseconds.</div>
</div>
<div class="col-first odd-row-color"><code>long</code></div>
<div class="col-second odd-row-color"><code><a href="#maximumDelay()" class="member-name-link">maximumDelay</a></code></div>
<div class="col-last odd-row-color">
<div class="block">The maximum delay between retry attempts in milliseconds.</div>
</div>
<div class="col-first even-row-color"><code>int</code></div>
<div class="col-second even-row-color"><code><a href="#maxRetries()" class="member-name-link">maxRetries</a></code></div>
<div class="col-last even-row-color">
<div class="block">The maximum number of transaction retry attempts.</div>
</div>
</div>
</section>
</li>
<!-- =========== FIELD SUMMARY =========== -->
<li>
<section class="field-summary" id="field-summary">
<h2>Field Summary</h2>
<div class="caption"><span>Fields</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Field</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>static final long</code></div>
<div class="col-second even-row-color"><code><a href="#DEFAULT_INITIAL_DELAY" class="member-name-link">DEFAULT_INITIAL_DELAY</a></code></div>
<div class="col-last even-row-color">
<div class="block">Default <a href="#initialDelay()">initial delay</a>, in milliseconds, used when the <a href="#initialDelay()"><code>initialDelay</code></a>
 value is not explicitly set in an instance of this annotation.</div>
</div>
<div class="col-first odd-row-color"><code>static final int</code></div>
<div class="col-second odd-row-color"><code><a href="#DEFAULT_MAX_RETRIES" class="member-name-link">DEFAULT_MAX_RETRIES</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Default <a href="#maxRetries()">maximum number of retry attempts</a>, used when the <a href="#maxRetries()"><code>maxRetries</code></a>
 value is not explicitly set in an instance of this annotation.</div>
</div>
<div class="col-first even-row-color"><code>static final long</code></div>
<div class="col-second even-row-color"><code><a href="#DEFAULT_MAXIMUM_DELAY" class="member-name-link">DEFAULT_MAXIMUM_DELAY</a></code></div>
<div class="col-last even-row-color">
<div class="block">Default <a href="#maximumDelay()">maximum delay</a>, in milliseconds, used when the <a href="#maximumDelay()"><code>maximumDelay</code></a>
 value is not explicitly set in an instance of this annotation.</div>
</div>
</div>
</section>
</li>
</ul>
</section>
<section class="details" id="annotation-interface-element-detail">
<ul class="details-list">
<!-- ============ FIELD DETAIL =========== -->
<li>
<section class="field-details" id="field-detail">
<h2>Field Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="DEFAULT_MAX_RETRIES">
<h3>DEFAULT_MAX_RETRIES</h3>
<div class="member-signature"><span class="modifiers">static final</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">DEFAULT_MAX_RETRIES</span></div>
<div class="block">Default <a href="#maxRetries()">maximum number of retry attempts</a>, used when the <a href="#maxRetries()"><code>maxRetries</code></a>
 value is not explicitly set in an instance of this annotation.
 This default value can be overridden by configuring the <code>maxRetriesDefault</code> property on the aspect itself.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../constant-values.html#org.dellroad.stuff.spring.RetryTransaction.DEFAULT_MAX_RETRIES">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="DEFAULT_INITIAL_DELAY">
<h3>DEFAULT_INITIAL_DELAY</h3>
<div class="member-signature"><span class="modifiers">static final</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">DEFAULT_INITIAL_DELAY</span></div>
<div class="block">Default <a href="#initialDelay()">initial delay</a>, in milliseconds, used when the <a href="#initialDelay()"><code>initialDelay</code></a>
 value is not explicitly set in an instance of this annotation.
 This default value can be overridden by configuring the <code>initialDelayDefault</code> property on the aspect itself.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../constant-values.html#org.dellroad.stuff.spring.RetryTransaction.DEFAULT_INITIAL_DELAY">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="DEFAULT_MAXIMUM_DELAY">
<h3>DEFAULT_MAXIMUM_DELAY</h3>
<div class="member-signature"><span class="modifiers">static final</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">DEFAULT_MAXIMUM_DELAY</span></div>
<div class="block">Default <a href="#maximumDelay()">maximum delay</a>, in milliseconds, used when the <a href="#maximumDelay()"><code>maximumDelay</code></a>
 value is not explicitly set in an instance of this annotation.
 This default value can be overridden by configuring the <code>maximumDelayDefault</code> property on the aspect itself.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../constant-values.html#org.dellroad.stuff.spring.RetryTransaction.DEFAULT_MAXIMUM_DELAY">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ ANNOTATION INTERFACE MEMBER DETAIL =========== -->
<li>
<section class="member-details">
<h2>Element Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="maxRetries()">
<h3>maxRetries</h3>
<div class="member-signature"><span class="return-type">int</span>&nbsp;<span class="element-name">maxRetries</span></div>
<div class="block">The maximum number of transaction retry attempts.

 <p>
 If the transaction fails, it will be retried at most this many times.
 This limit applies to retries only; it does not apply to the very first attempt, which is always made.
 So a value of zero means at most one attempt.

 <p>
 If this property is not set explicitly, the default value of <code>-1</code> indicates that the aspect-wide default value
 (<a href="#DEFAULT_MAX_RETRIES">4</a> by default), should be used.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>maximum number of transaction retry attempts</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd>-1</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="initialDelay()">
<h3>initialDelay</h3>
<div class="member-signature"><span class="return-type">long</span>&nbsp;<span class="element-name">initialDelay</span></div>
<div class="block">The initial delay between retry attempts in milliseconds.
 After the first transaction failure, we will pause for approximately this many milliseconds.
 For additional failures we apply a randomized exponential back-off, up to a maximum of <a href="#maximumDelay()"><code>maximumDelay()</code></a>.

 <p>
 If this property is not set explicitly, the default value of <code>-1</code> indicates that the aspect-wide default value
 (<a href="#DEFAULT_INITIAL_DELAY">100L</a> milliseconds by default), should be used.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>initial delay between retry attempts in milliseconds</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd>-1L</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="maximumDelay()">
<h3>maximumDelay</h3>
<div class="member-signature"><span class="return-type">long</span>&nbsp;<span class="element-name">maximumDelay</span></div>
<div class="block">The maximum delay between retry attempts in milliseconds.
 After the first transaction failure, we will pause for approximately <a href="#initialDelay()"><code>initialDelay()</code></a> milliseconds.
 For additional failures we apply a randomized exponential back-off, up to a maximum of this value.

 <p>
 If this property is not set explicitly, the default value of <code>-1</code> indicates that the aspect-wide default value
 (<a href="#DEFAULT_MAXIMUM_DELAY">30000L</a> milliseconds by default), should be used.</div>
<dl class="notes">
<dt>Returns:</dt>
<dd>maximum delay between retry attempts in milliseconds</dd>
</dl>
<dl class="notes">
<dt>Default:</dt>
<dd>-1L</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2024. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
